<%- include("../../views/partials/user/header") %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<div class="bg0 m-t-23 p-b-140">
    <div class="container">
        <div class="flex-w flex-sb-m p-b-52">
            <div class="flex-w flex-l-m filter-tope-group m-tb-10">
                <button class="stext-106 cl6 hov1 bor3 trans-04 m-r-32 m-tb-5 how-active1" data-filter="*">
                    All Products
                </button>

               <!-- <button class="stext-106 cl6 hov1 bor3 trans-04 m-r-32 m-tb-5" data-filter=".women">
                   Recurve
                </button>

                <button class="stext-106 cl6 hov1 bor3 trans-04 m-r-32 m-tb-5" data-filter=".men">
                    Compound
                </button>

               
                <button class="stext-106 cl6 hov1 bor3 trans-04 m-r-32 m-tb-5" data-filter=".shoes">
                 Accessories
                </button> -->
            </div>

            <div class="flex-w flex-c-m m-tb-10">
                <div class="flex-c-m stext-106 cl6 size-104 bor4 pointer hov-btn3 trans-04 m-r-8 m-tb-4 js-show-filter">
                    <i class="icon-filter cl2 m-r-6 fs-15 trans-04 zmdi zmdi-filter-list"></i>
                    <i class="icon-close-filter cl2 m-r-6 fs-15 trans-04 zmdi zmdi-close dis-none"></i>
                     Filter
                </div>

                <div class="flex-c-m stext-106 cl6 size-105 bor4 pointer hov-btn3 trans-04 m-tb-4 js-show-search">
                    <i class="icon-search cl2 m-r-6 fs-15 trans-04 zmdi zmdi-search"></i>
                    <i class="icon-close-search cl2 m-r-6 fs-15 trans-04 zmdi zmdi-close dis-none"></i>
                    Search
                </div>
            </div>
            
            <!-- Search product -->
            <div class="dis-none panel-search w-full p-t-10 p-b-15">
                <div class="bor8 dis-flex p-l-15">
                    <button class="size-113 flex-c-m fs-16 cl2 hov-cl1 trans-04">
                        <i class="zmdi zmdi-search"></i>
                    </button>
                    <form action="/search" method="post" >
                        <input class="mtext-107 cl2 size-114 plh2 p-r-15" type="text" name="query" placeholder="Search">
                    </form>
                </div>	
            </div>

            <!-- Filter -->
            <div class="dis-none panel-filter w-full p-t-10" >
                <div class="wrap-filter flex-w bg6 w-full p-lr-40 p-t-27 p-lr-15-sm  bg-secondary">
                    <form id="sort-form">
                        <div class="filter-col1 p-r-15 p-b-27">
                            <div class="mtext-102 cl2 p-b-15">Sort By</div>
                    
                            <select name="sort" class="filter-link stext-106 trans-04"  onchange="fetchProducts()">
                                <option value="default">Default</option>
                                <option value="popularity">Popularity</option>
                                <option value="az">Name: A to Z</option>
                                <option value="za">Name: Z to A</option>
                                <option value="priceLow">Price: Low to High</option>
                                <option value="priceHigh">Price: High to Low</option>
                            </select>
                        </div>
                    </form>
                    
                    

                    <div class="filter-col2 p-r-15 p-b-27">
                        <div class="mtext-102 cl2 p-b-15">Price</div>
                        <ul>
                            <li class="p-b-6">
                                <a href="/filterPrice?gt=0&lt=500" class="stext-106 trans-04 filter-link-active">
                                    Under $500
                                </a>
                            </li>
                            <li class="p-b-6">
                                <a href="/filterPrice?gt=500&lt=5000" class="stext-106 trans-04">
                                    $500.00 - $5000.00
                                </a>
                            </li>
                            <li class="p-b-6">
                                <a href="/filterPrice?gt=5000&lt=10000" class="stext-106 trans-04">
                                    $5000.00 - $10000.00
                                </a>
                            </li>
                            <li class="p-b-6">
                                <a href="/filterPrice?gt=10000&lt=50000" class="stext-106 trans-04">
                                    $10000.00 - $50000.00
                                </a>
                            </li>
                            <li class="p-b-6">
                                <a href="/filterPrice?gt=50000&lt=100000" class="stext-106 trans-04">
                                    $50000.00 - $100000.00
                                </a>
                            </li>
                            <li class="p-b-6">
                                <a href="/filterPrice?gt=100000" class="stext-106 trans-04">
                                    Above $100000.00+
                                </a>
                            </li>
                        </ul>
                    </div>
                    
                    

                    

                    <div class="filter-col3 p-r-15 p-b-27">
                        <div class="mtext-102 cl2 p-b-15">
                          Category
                        </div>
                        <ul>
                            <% for (let i = 0; i < categories.length; i++) { %>
                              <li>
                                
                                <a href="/filter?category=<%= categories[i]._id %>" class="stext-106 trans-04">
                                    <%= categories[i].categoryName %>
                                  </a>
                                  
                              </li>
                            <% } %>
                          </ul>
                          
                          
                          
                      </div>
                      
                </div>
            </div>
        </div>

        <div class="row g-3" id="product-list">
           <% for(let i=0;i<products.length;i++){%>
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="product-card h-100">
                        <div class="product-img-container">
                            <a href="/productDetails?id=<%= products[i]._id %>">
                                <img src="/uploads/<%= products[i].productImage[0] %>" 
                                     alt="<%=products[i].productImage%>" 
                                     class="product-img">
                            </a>
                            <div class="quick-view">
                                <a href="/productDetails?id=<%= products[i]._id %>" 
                                   class="btn btn-sm btn-light">Quick View</a>
                            </div>
                        </div>
                        <div class="product-info">
                            <h6 class="product-title text-truncate mb-1">
                                <%=products[i].productName %>
                            </h6>
                            <div class="product-price mb-1">
                                <span class="sale-price">Rs. <%= products[i].salePrice %></span>
                                <small class="original-price">Rs. <%= products[i].regularPrice %></small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="rating">★★★★☆</div>
                                <small class="stock">Stock: <%= products[i].quantity %></small>
                            </div>
                            <div class="product-actions">
                                <button onclick="addToCart('<%= products[i]._id %>')" 
                                        class="btn btn-sm btn-primary w-100 mb-1">
                                    Add to Cart
                                </button>
                                <button class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="far fa-heart"></i> Wishlist
                                </button>
                            </div>
                            
                        </div>
                    </div>
                </div>
            <% } %>
        </div>

        <!-- Load more -->
        <div class="flex-c-m flex-w w-full p-t-45">
            <a href="#" class="flex-c-m stext-101 cl5 size-103 bg2 bor1 hov-btn1 p-lr-15 trans-04">
                Load More
            </a>
        </div>
    </div>
</div>

<style>
.product-card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    transition: transform 0.2s, box-shadow 0.2s;
}

.product-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.product-img-container {
    position: relative;
    padding-top: 100%; /* 1:1 Aspect Ratio */
    background: #f8f9fa;
}

.product-img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: contain;
    padding: 0.5rem;
}

.quick-view {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    padding: 0.5rem;
    background: rgba(255,255,255,0.9);
    opacity: 0;
    transition: opacity 0.2s;
    text-align: center;
}

.product-card:hover .quick-view {
    opacity: 1;
}

.product-info {
    padding: 0.75rem;
}

.product-title {
    font-size: 0.9rem;
    color: #333;
    margin-bottom: 0.5rem;
    line-height: 1.2;
}

.product-price {
    display: flex;
    align-items: baseline;
    gap: 0.5rem;
}

.sale-price {
    color: #dc3545;
    font-weight: 600;
    font-size: 0.9rem;
}

.original-price {
    color: #6c757d;
    text-decoration: line-through;
    font-size: 0.8rem;
}

.rating {
    color: #ffc107;
    font-size: 0.8rem;
}

.stock {
    color: #6c757d;
    font-size: 0.75rem;
}

.product-actions {
    margin-top: 0.5rem;
}

.product-actions .btn {
    font-size: 0.8rem;
}

/* Responsive adjustments */
@media (max-width: 767px) {
    .product-title {
        font-size: 0.85rem;
    }
    .sale-price {
        font-size: 0.85rem;
    }
    .original-price {
        font-size: 0.75rem;
    }
}
</style>

<script>
function addToCart(productId) {
    fetch('/addCart', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ productId, quantity: 1 })
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                Swal.fire({
                    title: 'Success!',
                    text: 'Product added to cart successfully!',
                    icon: 'success',
                    confirmButtonText: 'OK'
                });
            } else {
                Swal.fire({
                    title: 'Error!',
                    text: data.message || 'Failed to add product to cart.',
                    icon: 'error',
                    confirmButtonText: 'Retry'
                });
            }
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Oops!',
                text: 'Something went wrong.',
                icon: 'error',
                confirmButtonText: 'Close'
            });
        });
}



//sorting
async function fetchProducts() {
    // const urlParams = new URLSearchParams(window.location.search);
    // const sort = urlParams.get('sort');
    const selectElement = document.querySelector('select[name="sort"]');
    
    // Get the selected value
    const sort = selectElement.value;

    try {
        const response = await fetch(`/Products?sort=${sort}`);
        const products = await response.json();
        
        const productList = document.getElementById('product-list');
        productList.innerHTML = '';
        
       
        products.forEach(product => {
            const productHTML = `
                <div class="col-6 col-md-4 col-lg-3">
                    <div class="product-card h-100">
                        <div class="product-img-container">
                            <a href="/productDetails?id=${product._id}">
                                <img src="/uploads/${product.productImage[0]}" 
                                     alt="${product.productName}" 
                                     class="product-img">
                            </a>
                            <div class="quick-view">
                                <a href="/productDetails?id=${product._id}" 
                                   class="btn btn-sm btn-light">Quick View</a>
                            </div>
                        </div>
                        <div class="product-info">
                            <h6 class="product-title text-truncate mb-1">
                                ${product.productName}
                            </h6>
                            <div class="product-price mb-1">
                                <span class="sale-price">Rs. ${product.salePrice}</span>
                                <small class="original-price">Rs. ${product.regularPrice}</small>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="rating">★★★★☆</div>
                                <small class="stock">Stock: ${product.quantity}</small>
                            </div>
                            <div class="product-actions">
                                <button onclick="addToCart('${product._id}')" 
                                        class="btn btn-sm btn-primary w-100 mb-1">
                                    Add to Cart
                                </button>
                                <button class="btn btn-sm btn-outline-secondary w-100">
                                    <i class="far fa-heart"></i> Wishlist
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            productList.insertAdjacentHTML('beforeend', productHTML);
        });
    } catch (error) {
        console.error('Error:', error);
    }
}




</script>

<%- include("../../views/partials/user/footer") %>
